<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="doctest">
<title>Converting a package to use doctest • doctest</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Converting a package to use doctest">
<meta property="og:description" content="doctest">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-dark navbar-expand-lg bg-primary"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">doctest</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.3.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/doctest.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/conversion.html">Converting a package to use doctest</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/hughjonesd/doctest/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Converting a package to use doctest</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/hughjonesd/doctest/blob/HEAD/vignettes/conversion.Rmd" class="external-link"><code>vignettes/conversion.Rmd</code></a></small>
      <div class="d-none name"><code>conversion.Rmd</code></div>
    </div>

    
    
<p><a href="https://hughjonesd.github.io/doctest/">Doctest</a> is an R
package to let you write doctests. Doctests are chunks of code which act
as both examples for your users, and tests of your package’s
functionality. The doctest package does this by letting you add <a href="https://testthat.r-lib.org" class="external-link">testthat</a> tests to your <a href="https://roxygen2.r-lib.org" class="external-link">roxygen</a> documentation.</p>
<p>This article gives a real world example of how to convert an R
package to use doctest. I’ll use <a href="https://hughjonesd.github.io/onetime/dev/" class="external-link">onetime</a>, a small
package which lets you run code only once. Onetime 0.1.0 is on CRAN, so
we will be dogfooding real production code.</p>
<p>To follow along, you’ll need to be familiar with both testthat and
roxygen. Both packages have documentation and tutorials elsewhere.</p>
<div class="section level2">
<h2 id="setting-up-doctest">Setting up doctest<a class="anchor" aria-label="anchor" href="#setting-up-doctest"></a>
</h2>
<p>My first step, obviously, was to install the doctest package:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">remotes</span><span class="fu">::</span><span class="fu">install_github</span><span class="op">(</span><span class="st">"hughjonesd/doctest"</span><span class="op">)</span></span></code></pre></div>
<p>Doctest is not on CRAN yet, but don’t worry, because you don’t need
to add it as a package dependency. You can just use it on your own
machine when you build your package.</p>
<p>Next, I added the doctest roclet <code>dt_roclet</code> to onetime’S
DESCRIPTION FILE:</p>
<pre><code><span><span class="va">Roxygen</span><span class="op">:</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>roclets <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"collate"</span>, <span class="st">"rd"</span>, <span class="st">"namespace"</span>, </span>
<span>              <span class="st">"doctest::dt_roclet"</span><span class="op">)</span><span class="op">)</span> </span></code></pre>
<p>Now, whenever I run <code>devtools::document()</code>, it will create
doctests in the <code>tests/testthat</code> directory, as well doing the
usual roxygen tasks like writing .Rd files. I already had
<code>tests/testthat</code> set up so I didn’t need to do anything more
in this direction.</p>
<p>One caveat: if you hit <code>Ctrl+Shift+D</code> in RStudio, it won’t
run the doctest roclet. You need to type
<code>devtools::document()</code> or <code><a href="https://roxygen2.r-lib.org/reference/roxygenize.html" class="external-link">roxygen2::roxygenize()</a></code>
on the command line. Otherwise your doctest tags won’t be
recognized.</p>
</div>
<div class="section level2">
<h2 id="converting-examples-to-doctest-sections">Converting <code>@examples</code> to <code>@doctest</code>
sections<a class="anchor" aria-label="anchor" href="#converting-examples-to-doctest-sections"></a>
</h2>
<p>My next step was to “Find in files” all my <code>@examples</code>
tags and change them to <code>@doctest</code> tags.
<code>@doctest</code> sections create examples in Rd files, just like
<code>@examples</code> sections. So I expected this to make no
difference to the output from <code>document()</code>.</p>
<div class="section level4">
<h4 id="before">Before<a class="anchor" aria-label="anchor" href="#before"></a>
</h4>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' @examples</span></span>
<span><span class="co">#' oo &lt;- options(onetime.dir = tempdir(check = TRUE))</span></span>
<span><span class="co">#' id &lt;- sample(10000L, 1)</span></span>
<span><span class="co">#' ...</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="after">After<a class="anchor" aria-label="anchor" href="#after"></a>
</h4>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' @doctest</span></span>
<span><span class="co">#' oo &lt;- options(onetime.dir = tempdir(check = TRUE))</span></span>
<span><span class="co">#' id &lt;- sample(10000L, 1)</span></span>
<span><span class="co">#' ...</span></span></code></pre></div>
<p>Indeed, after I ran <code>devtools::document()</code>, my .Rd files
were unchanged, apart from a few deleted empty lines in the examples. I
judged that these were not important, so I made my first commit.</p>
<p>At this stage, you might want to create a new branch for your
commits, using <code>git branch</code> on the command line, or clicking
the “new branch” button in RStudio. I was gung ho, so I just put <a href="https://github.com/hughjonesd/onetime/commit/1c6400cac3528c27ffd2d397250da527fa2dbf7d?diff=split" class="external-link">my
commit</a> on the master branch.</p>
<p>I made one exception: I left the <code>@examples</code> tag unchanged
in the <code>set_ok_to_store()</code> function. This is a function with
side effects on the user’s installation; testing it needs to be done
carefully. I thought that a doctest would need too much complex setup,
so I left it as is. There is an existing test for
<code>set_ok_to_store()</code> anyway.</p>
</div>
</div>
<div class="section level2">
<h2 id="creating-doctests-by-adding-expectations">Creating doctests by adding expectations<a class="anchor" aria-label="anchor" href="#creating-doctests-by-adding-expectations"></a>
</h2>
<p>So far, nothing has actually changed. To generate doctests from my
examples, I needed to add some <em>expectations</em> to my code.</p>
<p>If you know testthat, doctest expectations will look very familiar.
In testthat, you write:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">expect_equal</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, <span class="fl">2.71828183</span><span class="op">)</span></span></code></pre></div>
<p>In a <code>@doctest</code> roxygen section, this becomes:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' @expect equal(2.71828183)</span></span>
<span><span class="co">#' exp(1)</span></span></code></pre></div>
<p>where <code>exp(1)</code> is part of your example code. Similarly, in
testthat you might write:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">expect_warning</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="st">"foo"</span><span class="op">)</span>, <span class="st">"not numeric"</span><span class="op">)</span></span></code></pre></div>
<p>In a <code>@doctest</code> section you might write:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' @expect warning("not numeric")</span></span>
<span><span class="co">#' mean("foo")</span></span></code></pre></div>
<p>In other words:</p>
<ul>
<li>Use the <code>@expect</code> tag to create an expectation.</li>
<li>After <code>@expect</code>, write a testthat expectation, without
the <code>expect_</code> prefix.</li>
<li>The next R expression after the <code>@expect</code> line becomes
the first argument to the expectation.</li>
</ul>
</div>
<div class="section level2">
<h2 id="doctests-for-messaging-functions">Doctests for messaging functions<a class="anchor" aria-label="anchor" href="#doctests-for-messaging-functions"></a>
</h2>
<p>I started with onetime’s messaging functions, which print a message
or warning only once. For example,
<code>onetime_message_confirm()</code> had the following
<code>@doctest</code> section:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' @doctest</span></span>
<span><span class="co">#' oo &lt;- options(onetime.dir = tempdir(check = TRUE))</span></span>
<span><span class="co">#' id &lt;- sample(10000L, 1L)</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' onetime_message_confirm("A message to show one or more times", id = id)</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' onetime_reset(id = id)</span></span>
<span><span class="co">#' options(oo)</span></span></code></pre></div>
<p>I want to check that when this example code runs, the user indeed
sees a message. So I added an expectation:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' @doctest</span></span>
<span><span class="co">#' oo &lt;- options(onetime.dir = tempdir(check = TRUE))</span></span>
<span><span class="co">#' id &lt;- sample(10000L, 1L)</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @expect message("A message")</span></span>
<span><span class="co">#' onetime_message_confirm("A message to show one or more times", id = id)</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' onetime_reset(id = id)</span></span></code></pre></div>
<p>That was simple. To check everything was working, I ran
<code>devtools::document()</code> again. It produced a new file under
<code>tests/testthat</code>, called
<code>test-doctest-onetime_message_confirm.R</code>:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Generated by doctest: do not edit by hand</span></span>
<span><span class="co"># Please edit file in R/messages.R</span></span>
<span></span>
<span><span class="fu">test_that</span><span class="op">(</span><span class="st">"Doctest: onetime_message_confirm"</span>, <span class="op">{</span></span>
<span>  <span class="co"># Created from @doctest for `onetime_message_confirm`</span></span>
<span>  <span class="co"># Source file: R/messages.R</span></span>
<span>  <span class="co"># Source line: 110</span></span>
<span>  <span class="va">oo</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>onetime.dir <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span>check <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">id</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">10000L</span>, <span class="fl">1L</span><span class="op">)</span></span>
<span>  <span class="fu">expect_message</span><span class="op">(</span><span class="fu">onetime_message_confirm</span><span class="op">(</span><span class="st">"A message to show one or more times"</span>, id <span class="op">=</span> <span class="va">id</span><span class="op">)</span>,</span>
<span>  <span class="st">"A message"</span><span class="op">)</span></span>
<span>  <span class="fu">onetime_reset</span><span class="op">(</span>id <span class="op">=</span> <span class="va">id</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span><span class="va">oo</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>This looked fine, so I ran my tests using <code>Ctrl+Shift+T</code>,
and the new test passed.</p>
<p>Notice the warning in the comment at the top of the test file. If you
edit this file, it will be overwritten next time you run the doctest
roclet. If you want to edit it manually, you should change its name to
something without <code>doctest</code>, and remove the
<code>Generated by doctest</code> stamp. Then you’ll just have a normal
testthat test which you can edit as you please. If you don’t want to
regenerate the automated test file again, then remember to edit the
relevant <code>@doctest</code> section, removing expectations or
replacing <code>@doctest</code> back with <code>@examples</code>.</p>
<p>My next doctest was more complex. The roxygen looked like this:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' @doctest</span></span>
<span><span class="va">...</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' for (n in 1:3) {</span></span>
<span><span class="co">#'   onetime_warning("will be shown once", id = id)</span></span>
<span><span class="co">#' }</span></span>
<span><span class="co">#'</span></span>
<span><span class="va">...</span></span></code></pre></div>
<p>It’s fine to use expectations inside a for loop, but my problem was
that I expected different things each time.
<code>onetime_warning()</code> shows its warning only the first time it
is called. So on the first time round the loop, I would expect a
warning. Afterwards I would expect no output.</p>
<p>I could have unrolled the loop, like this:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' @expect warning()</span></span>
<span><span class="co">#' onetime_warning("will be shown once", id = id)</span></span>
<span><span class="co">#' @expect silent()</span></span>
<span><span class="co">#' onetime_warning("will be shown once", id = id)</span></span>
<span><span class="co">#' @expect silent()</span></span>
<span><span class="co">#' onetime_warning("will be shown once", id = id)</span></span></code></pre></div>
<p>But I liked the loop because it made it very clear how
<code>onetime_warning()</code> worked. I wanted to follow the philosophy
“write great documentation, then add tests where appropriate” rather
than “turn your documentation into a test suite”.</p>
<p>So, I bit the bullet and wrote a more complex expectation:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' for (n in 1:3) {</span></span>
<span><span class="co">#' @expect warning(regexp = if (n == 1L) "once" else NA)</span></span>
<span><span class="co">#'   onetime_warning("will be shown once", id = id)</span></span>
<span><span class="co">#' }</span></span></code></pre></div>
<p>This is a bit ugly. It uses the fact that
<code>expect_warning(regexp = NA)</code> is equivalent to <em>not</em>
expecting a warning. So, on the first time round the loop, the
expectation checks for a warning matching the string
<code>"once"</code>; afterwards, it checks that there is no warning.</p>
<p>Notice that the <code>@expect</code> tag isn’t indented. Roxygen tags
have to come straight after the starting <code>#'</code> characters,
with at most one space.</p>
<p>Again, I ran <code>devtools::document()</code> and checked the new
test:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="kw">for</span> <span class="op">(</span><span class="va">n</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu">expect_warning</span><span class="op">(</span><span class="fu">onetime_warning</span><span class="op">(</span><span class="st">"will be shown once"</span>, id <span class="op">=</span> <span class="va">id</span><span class="op">)</span>, regexp <span class="op">=</span> <span class="kw">if</span> <span class="op">(</span><span class="va">n</span> <span class="op">==</span></span>
<span>    <span class="fl">1L</span><span class="op">)</span> <span class="st">"once"</span> <span class="kw">else</span> <span class="cn">NA</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span></code></pre></div>
<p>Fine. I ran the test and again, it passed.</p>
<p>I added some more similar tests and then made a <a href="https://github.com/hughjonesd/onetime/commit/a870ede984f6523b32c0da8a54ca114e9a1bba66?diff=split" class="external-link">commit</a>.
I had set up Github actions to run <code>R CMD check</code>, so I knew
that the tests would also be checked on different platforms. Happily,
they all passed.</p>
</div>
<div class="section level2">
<h2 id="adding-doctests-for-utility-functions">Adding doctests for utility functions<a class="anchor" aria-label="anchor" href="#adding-doctests-for-utility-functions"></a>
</h2>
<p>Next I added some doctests for utility functions, which manipulate
various aspects of onetime’s on-disk records. Mostly these don’t print
output, so instead I tested their return value. For example,
<code>onetime_been_done()</code>, which checks if a particular onetime
call has already been made, got a doctest like this:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' @expect false()</span></span>
<span><span class="co">#' onetime_been_done(id = id)</span></span>
<span><span class="co">#' onetime_message("Creating an ID",  id = id)</span></span>
<span><span class="co">#' @expect true()</span></span>
<span><span class="co">#' onetime_been_done(id = id)</span></span></code></pre></div>
<p>The function <code>onetime_dir()</code> is very simple and just
returns a file path. Its example was simple too:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' @doctest</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' onetime_dir("my-folder")</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' oo &lt;- options(onetime.dir = tempdir(check = TRUE))</span></span>
<span><span class="co">#' onetime_dir("my-folder")</span></span>
<span><span class="co">#' options(oo)</span></span></code></pre></div>
<p>I decided to just test the first call to <code>onetime_dir()</code>,
confirming that the result ended with the subfolder I passed in. The
second call would return a temporary directory, which would be different
between different R sessions, so I wasn’t sure how to test it usefully.
In fact, to skip unnecessary code from the test, I used the
<code>@omit</code> tag:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' @expect match("my-folder$")</span></span>
<span><span class="co">#' onetime_dir("my-folder")</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @omit</span></span>
<span><span class="co">#' oo &lt;- options(onetime.dir = tempdir(check = TRUE))</span></span>
<span><span class="va">...</span></span></code></pre></div>
<p><code>@omit</code> omits everything after it from the generated test.
This code created a very simple test file in
<code>test-doctest-onetime_dir.R</code>:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Generated by doctest: do not edit by hand</span></span>
<span><span class="co"># Please edit file in R/utils.R</span></span>
<span></span>
<span><span class="fu">test_that</span><span class="op">(</span><span class="st">"Doctest: onetime_dir"</span>, <span class="op">{</span></span>
<span>  <span class="co"># Created from @doctest for `onetime_dir`</span></span>
<span>  <span class="co"># Source file: R/utils.R</span></span>
<span>  <span class="co"># Source line: 138</span></span>
<span>  <span class="fu">expect_match</span><span class="op">(</span><span class="fu">onetime_dir</span><span class="op">(</span><span class="st">"my-folder"</span><span class="op">)</span>, <span class="st">"my-folder$"</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>I ran these tests and <a href="https://github.com/hughjonesd/onetime/commit/cec1949a0129f00310dec23a12b411092dfbe3fe?diff=split" class="external-link">committed</a>
them.</p>
<p>Lastly, I added tests for my final functions. There’s nothing new
here. You can see the <a href="https://github.com/hughjonesd/onetime/commit/d3be66faabee09929deceafc9598488efd0ae8ee?diff=split" class="external-link">commit</a>
on GitHub.</p>
</div>
<div class="section level2">
<h2 id="adding-doctest-to-suggests">Adding doctest to Suggests:<a class="anchor" aria-label="anchor" href="#adding-doctest-to-suggests"></a>
</h2>
<p>Now that my doctests were working, I decided to make it easy for
other developers to work on my package too. In the onetime DESCRIPTION
file, I added doctest to <code>Suggests:</code>, and added a
<code>Remotes:</code> field pointing to the <a href="https://github.com/hughjonesd/doctest" class="external-link">github repository</a>. This
is a oneliner with the usethis package:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">usethis</span><span class="fu">::</span><span class="fu">use_dev_package</span><span class="op">(</span><span class="st">"doctest"</span>, type <span class="op">=</span> <span class="st">"Suggests"</span>, </span>
<span>                         remote <span class="op">=</span> <span class="st">"hughjonesd/doctest"</span><span class="op">)</span></span></code></pre></div>
<p>There is a tradeoff here: adding the doctest dependency will help
other developers, but CRAN doesn’t allow <code>Remotes:</code> fields in
packages. So when I submit the next version, I’ll have to remove the
dependency again.</p>
</div>
<div class="section level2">
<h2 id="conclusion">Conclusion<a class="anchor" aria-label="anchor" href="#conclusion"></a>
</h2>
<p>This was encouragingly easy. All my tests passed the first time. Now
I can develop more securely, knowing that if my changes stop my examples
working, doctest will help to catch that.</p>
<p>I followed some principles when making these changes to my
package:</p>
<ul>
<li><p>Start small, by changing <code>@examples</code> tags to
<code>@doctest</code> tags. Doctest is a new package, so you want to
make sure it doesn’t do anything bad. (If it does, please <a href="https://github.com/hughjonesd/doctest/issues" class="external-link">file a bug
report</a>!) Obviously, you should make sure your code is checked in to
version control before using doctest.</p></li>
<li><p>Keep doctests simple. Focus example code on its key role, which
is to teach the user about your package. If you need to make big
changes, or if your expectations are becoming complex, consider
splitting them out into a “proper” testthat test.</p></li>
</ul>
<p>There are many features of doctest that I didn’t need to use for this
small package, including the <code>@expectRaw</code> and
<code>@snap</code> tags to generate other expectations, and the
<code>@testRaw</code> tag to add code to your tests. You can read about
those in the package documentation or in the main vignette:
<code><a href="../articles/doctest.html">vignette("doctest")</a></code>.</p>
<p>If you are using doctest in your package, I’d love to hear about it.
There is a <a href="https://github.com/hughjonesd/doctest/issues/8" class="external-link">github issue</a>
where end users can add their package. And of course, I welcome bug
reports, enhancement requests and feedback.</p>
<p>Happy testing!</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by David Hugh-Jones.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
